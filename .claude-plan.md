# Implementation Plan: Monthly Check Notification & Reminder System

## Overview
Implement a complete notification system for monthly vehicle checks that sends automatic notifications, daily reminders, and manager alerts based on user requirements.

## Existing Infrastructure Analysis

### What We Have:
- ✅ Email service with Nodemailer (bikes@yedidim-il.org)
- ✅ Monthly check scheduler (runs 1st of month at midnight)
- ✅ Complete CRUD API for monthly checks
- ✅ Firestore collections: riders, vehicles, monthly_checks
- ✅ Frontend pages: MonthlyChecks.jsx, MonthlyCheckForm.jsx
- ✅ Node-cron with Asia/Jerusalem timezone

### What Needs Work:
- ❌ Scheduler runs at midnight instead of 9:00 AM
- ❌ No notification sending when checks are created
- ❌ No daily reminder system
- ❌ No manager alert on defects
- ❌ No manual trigger endpoint
- ❌ No automatic vehicle kilometers update
- ❌ Form fields don't match user specifications
- ❌ Vercel deployment issue (cron doesn't work in serverless)

## Implementation Steps

### Phase 1: Update Monthly Check Scheduler
**File:** `backend/schedulers/monthlyCheckScheduler.js`

**Changes:**
1. Change cron schedule from `'0 0 1 * *'` (midnight) to `'0 9 1 * *'` (9:00 AM)
2. Add notification sending after creating checks
3. For each rider with active vehicle:
   - Send email notification using `emailService.sendMonthlyCheckReminder()`
   - Store notification record in Firestore
   - Log notification status

**Code pattern:**
```javascript
// After creating check
await emailService.sendMonthlyCheckReminder(
  rider.email,
  rider.name,
  vehicle.licensePlate,
  month,
  year
);
```

### Phase 2: Create Daily Reminder System
**New File:** `backend/schedulers/dailyReminderScheduler.js`

**Purpose:** Send daily reminders at 9:00 AM for pending checks

**Implementation:**
1. Cron job: `'0 9 * * *'` (daily at 9:00 AM Israel time)
2. Query Firestore for pending monthly checks (status = 'pending')
3. Filter checks older than 1 day
4. For each pending check:
   - Get rider email and vehicle details
   - Send reminder email
   - Log reminder sent

**Logic:**
```javascript
const pendingChecks = await monthlyCheckModel.getByStatus('pending');
const checksNeedingReminder = pendingChecks.filter(check => {
  const daysSinceCreated = getDaysDifference(check.createdAt, new Date());
  return daysSinceReminder >= 1;
});
```

### Phase 3: Manual Trigger Endpoint
**File:** `backend/routes/monthly-checks-firebase.js`

**New Endpoint:** `POST /api/monthly-checks/:id/send-notification`

**Purpose:** Allow manager to manually send notification to rider

**Implementation:**
1. Get monthly check by ID
2. Verify check is pending
3. Get rider and vehicle details
4. Send notification email
5. Return success/failure status

**Authorization:** Only managers/admins can trigger

### Phase 4: Manager Defect Alert System
**File:** `backend/routes/monthly-checks-firebase.js`

**Modify:** `PUT /api/monthly-checks/:id` endpoint

**Changes:**
1. After updating check, inspect formData for defects
2. Check for:
   - Any field with value "לא תקין" (not functioning)
   - Any failed items
3. If defect found:
   - Get manager email (user "אבי")
   - Send email with defect details
   - Create in-app notification

**New email template in emailService.js:**
```javascript
async sendDefectAlert(managerEmail, riderName, vehiclePlate, defects) {
  // Email with defect details in Hebrew
  // Include vehicle, rider, and defect list
}
```

### Phase 5: Update Form Fields
**File:** `frontend/src/pages/MonthlyCheckForm.jsx`

**Changes:**
1. **Oil field:** Change options from "תקין/נמוך/לא ניתן לבדוק" to "תקין/נמוך/לא תקין"
2. **Box screws (scooters):** Change from "בוצע/לא בוצע/לא רלוונטי" to "בוצע/לא בוצע"
3. Add vehicle-type conditional rendering:
   - **Scooters:** Show oil, box screws, box rail lubrication
   - **Motorcycles:** Show oil, chain lubrication

**Validation:** Make kilometers field required

### Phase 6: Automatic Kilometers Update
**File:** `backend/routes/monthly-checks-firebase.js`

**Modify:** `PUT /api/monthly-checks/:id` endpoint

**Logic:**
1. When check is completed (status changed to 'completed')
2. Extract kilometers from formData
3. Get vehicleId from check
4. Update vehicle's currentKilometers field
5. Log the update

**Code:**
```javascript
if (status === 'completed' && formData.kilometers) {
  await vehicleModel.update(vehicleId, {
    currentKilometers: formData.kilometers,
    lastKilometerUpdate: new Date()
  });
}
```

### Phase 7: In-App Notifications
**New Collection:** `notifications` in Firestore

**Structure:**
```javascript
{
  userId: string,
  type: 'monthly_check' | 'reminder' | 'defect_alert',
  title: string,
  message: string,
  read: boolean,
  createdAt: Timestamp,
  relatedId: string // monthly check ID
}
```

**Implementation:**
1. Create notification when check is created
2. Create notification for each reminder
3. Create notification for manager on defect
4. Frontend: Add notification bell icon in header
5. Query notifications on app load

### Phase 8: Vercel Production Deployment
**File:** `vercel.json`

**Issue:** Node-cron doesn't work in Vercel serverless functions

**Solution:** Use Vercel Cron Jobs (Hobby plan supports cron)

**Add to vercel.json:**
```json
{
  "crons": [
    {
      "path": "/api/cron/monthly-checks",
      "schedule": "0 9 1 * *"
    },
    {
      "path": "/api/cron/daily-reminders",
      "schedule": "0 9 * * *"
    }
  ]
}
```

**New Files:**
- `backend/api/cron/monthly-checks.js` - Handler for monthly check creation
- `backend/api/cron/daily-reminders.js` - Handler for daily reminders

**Both handlers:**
1. Verify request is from Vercel (check authorization header)
2. Call existing scheduler logic
3. Return status

### Phase 9: Push Notifications (Future Enhancement)
**Note:** User wants push notifications but no Firebase Cloud Messaging (FCM) is set up yet

**For now:** Skip push notifications, only implement:
- Email notifications
- In-app notifications

**Later:** When ready, add FCM:
1. Set up Firebase Cloud Messaging
2. Store FCM tokens in rider documents
3. Send push notification alongside email

## Files to Modify

1. **`backend/schedulers/monthlyCheckScheduler.js`**
   - Change time to 9:00 AM
   - Add email sending
   - Add in-app notification creation

2. **`backend/routes/monthly-checks-firebase.js`**
   - Add manual trigger endpoint
   - Add defect detection in update endpoint
   - Add automatic kilometers update

3. **`backend/services/emailService.js`**
   - Add defect alert email template

4. **`frontend/src/pages/MonthlyCheckForm.jsx`**
   - Update oil field options
   - Update box screws options
   - Add vehicle-type conditional fields
   - Make kilometers required

5. **`vercel.json`**
   - Add cron job definitions

## New Files to Create

1. **`backend/schedulers/dailyReminderScheduler.js`**
   - Daily reminder cron job

2. **`backend/models/firestore/NotificationModel.js`**
   - Notification Firestore model

3. **`backend/routes/notifications.js`**
   - API endpoints for notifications

4. **`backend/api/cron/monthly-checks.js`**
   - Vercel cron handler

5. **`backend/api/cron/daily-reminders.js`**
   - Vercel cron handler

6. **`frontend/src/components/NotificationBell.jsx`**
   - Notification UI component

## Critical Considerations

### Email Configuration
- User "אבי" needs to be identified in system for manager alerts
- Later: Make manager email configurable in settings

### Timezone
- All times are Israel time (Asia/Jerusalem)
- Vercel cron uses UTC - need to account for this

### Performance
- Daily reminder query should be indexed in Firestore
- Notification queries should be limited and paginated

### Error Handling
- If email fails, log error but don't block check creation
- Retry logic for failed notifications (optional)

### Testing
- Test scheduler in development before Vercel deployment
- Test email sending with real email addresses
- Test defect detection with various form submissions

## Implementation Order

1. ✅ Phase 5 (Form fields) - Quick UI fix
2. ✅ Phase 1 (Update scheduler time + notifications)
3. ✅ Phase 2 (Daily reminders)
4. ✅ Phase 3 (Manual trigger)
5. ✅ Phase 4 (Defect alerts)
6. ✅ Phase 6 (Kilometers update)
7. ✅ Phase 7 (In-app notifications)
8. ✅ Phase 8 (Vercel deployment)

## Success Criteria

- ✅ Riders receive email at 9:00 AM on 1st of month
- ✅ Daily reminders sent until form completed
- ✅ Manager can manually trigger notification
- ✅ Vehicle kilometers automatically updated
- ✅ Manager receives email when defect marked
- ✅ Form fields match user specifications
- ✅ System works in Vercel production
- ✅ In-app notifications visible to users
