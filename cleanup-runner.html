<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>× ×™×§×•×™ ×§×‘×¦×™× ×›×¤×•×œ×™×</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #1565c0;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .danger {
      background: #d32f2f;
    }
    .danger:hover {
      background: #c62828;
    }
    .success {
      background: #388e3c;
    }
    .success:hover {
      background: #2e7d32;
    }
    #log {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
    }
    h1 {
      color: #1976d2;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      color: #856404;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #17a2b8;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      color: #0c5460;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§¹ × ×™×§×•×™ ×§×‘×¦×™× ×›×¤×•×œ×™× - ×¨×›×‘ 405</h1>

    <div class="warning">
      <strong>âš ï¸ ×©×™× ×œ×‘:</strong><br>
      ×›×œ×™ ×–×” ×™×ª×§×Ÿ ××ª ×”×‘×¢×™×” ×©×‘×” ×§×‘×¦×™× ××•×¤×™×¢×™× ×’× ×‘×‘×™×˜×•×—×™× × ×•×›×—×™×™× ×•×’× ×‘×™×©× ×™×.<br>
      ×”×§×‘×¦×™× ×™×©××¨×• ×¨×§ ×‘×‘×™×˜×•×—×™× × ×•×›×—×™×™×.
    </div>

    <div class="info">
      <strong>â„¹ï¸ ××” ×–×” ×™×¢×©×”?</strong><br>
      1. ×™×‘×“×•×§ ××™×œ×• ×§×‘×¦×™× ××•×¤×™×¢×™× ×‘×©×ª×™ ×”×ª×™×§×™×•×ª<br>
      2. ×™×¡×™×¨ ××ª ×”×§×™×©×•×¨ ×©×œ ×”×§×‘×¦×™× ××ª×™×§×™×™×ª "×‘×™×˜×•×—×™× ×™×©× ×™×"<br>
      3. ×”×§×‘×¦×™× ×™×©××¨×• ×¨×§ ×‘×ª×™×§×™×™×ª "×‘×™×˜×•×—×™× × ×•×›×—×™×™×"
    </div>

    <div style="margin: 20px 0;">
      <button onclick="step1_listFiles()">×©×œ×‘ 1: ×”×¦×’ ×§×‘×¦×™×</button>
      <button onclick="step2_fixDuplicates()" class="success">×©×œ×‘ 2: ×ª×§×Ÿ ×›×¤×™×œ×•×™×•×ª</button>
      <button onclick="step3_clearArchive()" class="danger">×©×œ×‘ 3: × ×§×” ××¨×›×™×•×Ÿ (××•×¤×¦×™×•× ×œ×™)</button>
    </div>

    <div id="log">×œ×—×¥ ×¢×œ "×©×œ×‘ 1" ×›×“×™ ×œ×”×ª×—×™×œ...</div>
  </div>

  <script>
    const API_URL = window.location.origin.includes('localhost')
      ? 'http://localhost:5000/api'
      : '/api';

    function log(message) {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('he-IL');
      logDiv.textContent += `[${timestamp}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').textContent = '';
    }

    async function getToken() {
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      if (!token) {
        alert('×œ× × ××¦× token - ×× × ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª ×ª×—×™×œ×”');
        throw new Error('No token found');
      }
      return token;
    }

    async function getVehicleId() {
      const token = await getToken();
      log('ğŸ” ××—×¤×© ×¨×›×‘ 405...');

      const response = await fetch(`${API_URL}/vehicles?search=405`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();
      const vehicle = data.vehicles.find(v => v.internalNumber === '405' || v.licensePlate === '405');

      if (!vehicle) {
        alert('×¨×›×‘ 405 ×œ× × ××¦×!');
        throw new Error('Vehicle 405 not found');
      }

      log(`âœ… × ××¦× ×¨×›×‘: ${vehicle.internalNumber} (${vehicle.licensePlate})`);
      return vehicle.id;
    }

    async function step1_listFiles() {
      try {
        clearLog();
        log('ğŸ“‹ ×©×œ×‘ 1: ×‘×•×“×§ ×§×‘×¦×™×...\n');

        const vehicleId = await getVehicleId();
        const token = await getToken();

        const response = await fetch(`${API_URL}/cleanup-duplicate-files`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            vehicleId: vehicleId,
            action: 'list'
          })
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        log(`\nğŸ“Š ×ª×•×¦××•×ª:`);
        log(`×‘×™×˜×•×—×™× × ×•×›×—×™×™×: ${result.data.insuranceCount} ×§×‘×¦×™×`);
        log(`×‘×™×˜×•×—×™× ×™×©× ×™×: ${result.data.archiveCount} ×§×‘×¦×™×\n`);

        if (result.data.insuranceFiles.length > 0) {
          log('ğŸ“ ×§×‘×¦×™× ×‘×‘×™×˜×•×—×™× × ×•×›×—×™×™×:');
          result.data.insuranceFiles.forEach(f => log(`  - ${f.name}`));
        }

        if (result.data.archiveFiles.length > 0) {
          log('\nğŸ“ ×§×‘×¦×™× ×‘×‘×™×˜×•×—×™× ×™×©× ×™×:');
          result.data.archiveFiles.forEach(f => log(`  - ${f.name}`));
        }

        log('\nâœ… ×¡×™×•× ×©×œ×‘ 1');
        log('\n×œ×—×¥ ×¢×œ "×©×œ×‘ 2" ×›×“×™ ×œ×ª×§×Ÿ ×›×¤×™×œ×•×™×•×ª...');

      } catch (error) {
        log(`\nâŒ ×©×’×™××”: ${error.message}`);
        console.error(error);
      }
    }

    async function step2_fixDuplicates() {
      try {
        if (!confirm('×”×× ××ª×” ×‘×˜×•×—? ×–×” ×™×¡×™×¨ ×§×‘×¦×™× ×›×¤×•×œ×™× ××ª×™×§×™×™×ª ×”××¨×›×™×•×Ÿ')) {
          return;
        }

        clearLog();
        log('ğŸ”§ ×©×œ×‘ 2: ××ª×§×Ÿ ×›×¤×™×œ×•×™×•×ª...\n');

        const vehicleId = await getVehicleId();
        const token = await getToken();

        const response = await fetch(`${API_URL}/cleanup-duplicate-files`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            vehicleId: vehicleId,
            action: 'remove-duplicates'
          })
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        log(`\nâœ… ${result.message}`);
        log(`× ××¦××• ×›×¤×™×œ×•×™×•×ª: ${result.data.duplicatesFound}`);
        log(`×ª×•×§× ×•: ${result.data.fixedCount}`);

        if (result.data.results.length > 0) {
          log('\nğŸ“‹ ×§×‘×¦×™× ×©×ª×•×§× ×•:');
          result.data.results.forEach(r => log(`  âœ… ${r.name}`));
        }

        log('\nğŸ‰ ×”×ª×™×§×•×Ÿ ×”×•×©×œ× ×‘×”×¦×œ×—×”!');
        log('×¢×›×©×™×• ×”×§×‘×¦×™× × ××¦××™× ×¨×§ ×‘×‘×™×˜×•×—×™× × ×•×›×—×™×™×.');

      } catch (error) {
        log(`\nâŒ ×©×’×™××”: ${error.message}`);
        console.error(error);
      }
    }

    async function step3_clearArchive() {
      try {
        if (!confirm('âš ï¸ ×–×” ×™××—×§ ××ª ×›×œ ×”×§×‘×¦×™× ××ª×™×§×™×™×ª ×”××¨×›×™×•×Ÿ! ×”×× ××ª×” ×‘×˜×•×—?')) {
          return;
        }

        clearLog();
        log('ğŸ—‘ï¸ ×©×œ×‘ 3: ×× ×§×” ××¨×›×™×•×Ÿ...\n');

        const vehicleId = await getVehicleId();
        const token = await getToken();

        const response = await fetch(`${API_URL}/cleanup-duplicate-files`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            vehicleId: vehicleId,
            action: 'clear-archive'
          })
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message);
        }

        log(`\nâœ… ${result.message}`);
        log(`× ××—×§×•: ${result.data.deleted} ×§×‘×¦×™×`);
        log(`× ×›×©×œ×•: ${result.data.failed} ×§×‘×¦×™×`);

        if (result.data.results.length > 0) {
          log('\nğŸ“‹ ×¤×™×¨×•×˜:');
          result.data.results.forEach(r => {
            const icon = r.status === 'deleted' ? 'âœ…' : 'âŒ';
            log(`  ${icon} ${r.name}`);
          });
        }

        log('\nğŸ‰ ×”× ×™×§×•×™ ×”×•×©×œ×!');

      } catch (error) {
        log(`\nâŒ ×©×’×™××”: ${error.message}`);
        console.error(error);
      }
    }
  </script>
</body>
</html>
