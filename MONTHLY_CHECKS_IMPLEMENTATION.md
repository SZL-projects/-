# מערכת בקרות חודשיות - סיכום יישום

## סקירה כללית
יושמה מערכת שלמה לניהול בקרות חודשיות עם הודעות אוטומטיות, תזכורות יומיות והתראות למנהלים.

## מה בוצע

### 1. עדכון טופס הבקרה החודשית ✅
**קובץ:** `frontend/src/pages/MonthlyCheckForm.jsx`

#### שינויים:
- **שדה שמן:** שונה מ"לא ניתן לבדוק" ל"לא תקין"
  - אפשרויות: תקין / נמוך / לא תקין

- **שדות חדשים לקטנועים:**
  - חיזוק ברגי ארגז: בוצע / לא בוצע
  - שימון מסילות ארגז: בוצע / לא בוצע

- **שדה חדש לאופנועים:**
  - שימון שרשרת: בוצע / לא בוצע

- **הצגה מותנית:** השדות מוצגים בהתאם לסוג הכלי (scooter/motorcycle)
- **ולידציה:** נוספה בדיקת חובה לכל השדות החדשים
- **דף סיכום:** מעודכן להציג את כל השדות החדשים

---

### 2. מתזמן חודשי משופר ✅
**קובץ:** `backend/schedulers/monthlyCheckScheduler.js`

#### שינויים:
- **שעת הפעלה:** שונתה מחצות (00:00) ל-9:00 בבוקר
- **שליחת מיילים:** כל בקרה חדשה מקבלת מייל הודעה אוטומטי
- **זמן ישראל:** שימוש ב-timezone: "Asia/Jerusalem"

#### איך זה עובד:
```javascript
// רץ ב-1 לכל חודש בשעה 09:00
cron.schedule('0 9 1 * *', ...)

// עבור כל רוכב פעיל עם כלי משויך:
// 1. יצירת בקרה חודשית חדשה
// 2. שליחת מייל הודעה לרוכב
```

---

### 3. מערכת תזכורות יומית ✅
**קובץ חדש:** `backend/schedulers/dailyReminderScheduler.js`

#### תכונות:
- **הפעלה יומית:** כל יום בשעה 09:00 בבוקר
- **סינון חכם:** בודק רק בקרות ממתינות (status = 'pending')
- **מניעת כפילויות:** לא שולח תזכורת יותר מפעם אחת ביום
- **מעקב:** שומר תאריך שליחת תזכורת אחרונה

#### לוגיקה:
```javascript
// רץ כל יום בשעה 09:00
cron.schedule('0 9 * * *', ...)

// עבור כל בקרה ממתינה בחודש הנוכחי:
// 1. בדיקה אם כבר נשלחה תזכורת היום
// 2. שליחת מייל תזכורת
// 3. עדכון lastReminderSent
```

---

### 4. שליחה ידנית למנהל ✅
**קובץ:** `backend/routes/monthly-checks-firebase.js`

#### Endpoint חדש:
```
POST /api/monthly-checks/:id/send-notification
```

#### תכונות:
- **הרשאות:** רק מנהל/מנהל-על
- **בדיקות:** מוודא שהבקרה במצב pending
- **שליחת מייל:** שולח תזכורת לרוכב
- **מעקב:** שומר מי שלח (manualReminderSentBy)

#### שימוש:
מנהל יכול לשלוח הודעה ידנית לרוכב ספציפי מדף הבקרות החודשיות.

---

### 5. עדכון אוטומטי של קילומטרז ✅
**קובץ:** `backend/routes/monthly-checks-firebase.js`

#### לוגיקה:
כאשר רוכב משלים בקרה (status = 'completed'):
```javascript
// עדכון הכלי
vehicles.update(vehicleId, {
  currentKilometers: parseInt(currentKm),
  lastKilometerUpdate: new Date()
})
```

#### תכונות:
- **אוטומטי לחלוטין:** מתבצע בעת סיום הבקרה
- **שקט:** לא מפריע אם נכשל (רק לוג)
- **דיוק:** ממיר למספר שלם

---

### 6. התראות למנהל על תקלות ✅
**קובץ:** `backend/routes/monthly-checks-firebase.js`

#### איתור תקלות:
המערכת בודקת אוטומטית:
- שמן: לא תקין / נמוך
- מים: לא תקין / נמוך
- בלמים / פנסים / מראות / קסדה: לא תקין
- ברגי ארגז / מסילות ארגז / שרשרת: לא בוצע

#### שליחת מייל:
```javascript
// כאשר מתגלות תקלות:
// 1. בניית רשימת תקלות
// 2. שליחת מייל מפורט למנהל
// 3. כולל פרטי כלי, רוכב, והערות
```

#### הגדרת מייל מנהל:
```env
MANAGER_EMAIL=bikes@yedidim-il.org
```

---

### 7. עדכון Server ✅
**קובץ:** `backend/server-firebase.js`

#### שינויים:
- **הוספת scheduler:** dailyReminderScheduler מופעל בהתחלה
- **Endpoints לבדיקה:**
  - `POST /api/admin/trigger-monthly-checks` - הרצה ידנית של פתיחת בקרות
  - `POST /api/admin/trigger-daily-reminders` - הרצה ידנית של תזכורות

---

## משתני סביבה חדשים

הוסף ל-`.env`:
```env
MANAGER_EMAIL=bikes@yedidim-il.org
```

---

## זרימת עבודה מלאה

### בראשון לחודש בשעה 09:00:
1. המתזמן החודשי מופעל
2. נוצרת בקרה חודשית לכל רוכב פעיל
3. נשלח מייל הודעה לכל רוכב

### כל יום בשעה 09:00:
1. המתזמן היומי מופעל
2. נבדקות כל הבקרות הממתינות
3. נשלחת תזכורת לרוכבים שלא השלימו

### כאשר רוכב ממלא בקרה:
1. הקילומטרז מתעדכן אוטומטית בכלי
2. אם יש תקלות - נשלח מייל למנהל
3. הבקרה מסומנת כהושלמה

### אפשרות נוספת למנהל:
- שליחה ידנית של תזכורת לרוכב ספציפי

---

## בדיקות שכדאי לבצע

### 1. בדיקה מקומית (Development)
```bash
# התחל את השרת
cd backend
npm run dev:firebase

# תראה:
# ✅ Monthly Check Scheduler started - יפעל ב-1 לכל חודש בשעה 09:00 בבוקר
# ✅ Daily Reminder Scheduler started - יפעל כל יום בשעה 09:00 בבוקר
```

### 2. הרצה ידנית לבדיקה
```bash
# פתיחת בקרות חודשיות
curl -X POST http://localhost:5000/api/admin/trigger-monthly-checks

# שליחת תזכורות יומיות
curl -X POST http://localhost:5000/api/admin/trigger-daily-reminders
```

### 3. בדיקת טופס
1. היכנס כרוכב עם כלי משויך
2. מלא בקרה חודשית
3. וודא שהשדות החדשים מופיעים (ברגי ארגז / שרשרת)
4. בדוק שהקילומטרז התעדכן בכלי

### 4. בדיקת התראות תקלות
1. מלא בקרה עם תקלה (למשל "שמן - לא תקין")
2. בדוק שהמנהל קיבל מייל
3. וודא שהמייל כולל את כל הפרטים

---

## נקודות חשובות

### ⚠️ Vercel / Production
המתזמנים הנוכחיים (node-cron) **לא עובדים ב-Vercel** כי זה serverless.
צריך להוסיף Vercel Cron Jobs (בשלב הבא).

### 📧 הגדרת מייל מנהל
כרגע המייל של המנהל מוגדר ב-`.env`.
בעתיד אפשר להוסיף הגדרה במערכת (בדף הגדרות).

### 🔒 אבטחה
Endpoints הניהול (trigger-monthly-checks, trigger-daily-reminders)
זמינים רק ב-development. בפרודקשן צריך להוסיף אימות.

---

## קבצים שהשתנו

### Frontend:
- ✅ `frontend/src/pages/MonthlyCheckForm.jsx` - עדכון טופס

### Backend:
- ✅ `backend/schedulers/monthlyCheckScheduler.js` - עדכון מתזמן חודשי
- ✅ `backend/schedulers/dailyReminderScheduler.js` - מתזמן יומי חדש
- ✅ `backend/routes/monthly-checks-firebase.js` - הוספת endpoint, עדכון אוטומטי, התראות
- ✅ `backend/server-firebase.js` - הוספת schedulers
- ✅ `backend/.env` - הוספת MANAGER_EMAIL

---

## הצלחה! 🎉

המערכת עכשיו:
- ✅ שולחת הודעות אוטומטיות בראשון לחודש בשעה 9:00
- ✅ שולחת תזכורות יומיות ב-9:00 לרוכבים שלא מילאו
- ✅ מאפשרת שליחה ידנית למנהל
- ✅ מעדכנת קילומטרז אוטומטית
- ✅ מתריעה למנהל על תקלות
- ✅ כוללת את כל השדות המבוקשים בטופס

**שלב הבא:** התאמה ל-Vercel Cron Jobs לפרודקשן
